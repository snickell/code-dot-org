apiVersion: skaffold/v4beta11
kind: Config
build:
  artifacts:
  - image: code-dot-org
    sync:
      infer:
      # rerun watching
      # /app/src/lib, /app/src/shared/middleware, /app/src/dashboard/legacy, /app/src/pegasus for **/*.{rb,ru,yml} (ignoring **/migrations/*.rb,test/**/*.rb)
      - '**/*.rb'
      - '**/*.ru'
      - '**/*.yml'
      - '**/*.js'
      - '**/*.jsx'
      - '**/*.json'
    docker:
      dockerfile: ./k8s/code-dot-org.dockerfile
      cacheFrom:
      - code-dot-org
      # - 475661607190.dkr.ecr.us-east-1.amazonaws.com/code.org:staging
    requires:
    - image: code-dot-org-static
      alias: CODE_DOT_ORG_STATIC
    - image: code-dot-org-db-seed
      alias: CODE_DOT_ORG_DB_SEED
  - image: code-dot-org-static
    docker:
      dockerfile: ./k8s/code-dot-org-static.dockerfile
      cacheFrom:
      - code-dot-org-static
      # - 475661607190.dkr.ecr.us-east-1.amazonaws.com/code.org-static:staging
  - image: code-dot-org-db-seed
    docker:
      dockerfile: ./k8s/code-dot-org-db-seed.dockerfile
      cacheFrom:
      - code-dot-org-db-seed
      # - 475661607190.dkr.ecr.us-east-1.amazonaws.com/code.org-db-seed:staging
  local:
    useBuildkit: true # required for caching layers, see https://github.com/moby/moby/issues/34715#issuecomment-589655390

profiles:
- name: development
  activation:
    - command: dev
    - kubeContext: docker-desktop

- name: development
  deploy:
    helm:
      releases:
      - name: dashboard
        chartPath: ./k8s/code.org/helm
        setValueTemplates:
          image: "{{.IMAGE_FULLY_QUALIFIED}}"
          development.localHomeDir: '{{ cmd "sh" "-c" "echo $HOME" }}'

portForward:
- resourceType: Service
  resourceName: dashboard
  port: 3000
- resourceType: Service
  resourceName: dashboard-db
  port: 3306
