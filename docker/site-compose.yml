# Docker Compose file for running the site locally.
#
# Set the FIXUID and FIXGID env variables with these commands (or put them in your .bash_profile / .bashrc):
# export FIXUID=$(id -u)
# export FIXGID=$(id -g)
#
# then run:
# docker-compose -f site-compose.yml up
#
# To clean up:
# docker-compose -f site-compose.yml down
#
# You can also run bash in a container, for example to run scripts in bin/:
# docker-compose -f site-compose.yml run site bash

version: "3"
services:
  site:
    # TODO: switch to codedotorg/cdo-ci or other new image
    image: codedotorg/code-dot-org:1.11.1
    user: ${FIXUID:-1000}:${FIXGID:-1000}
    volumes:
      - ../:/home/ci/code-dot-org:delegated
      - $HOME/.ssh:/home/ci/.ssh:ro
      - $HOME/.ssh:$HOME/.ssh:ro
      - rbenv:/home/ci/.rbenv
      - mysqldata:/var/lib/mysql
      - yarncache:/home/ci/.cache
      - gcloud_config:/home/ci/.config/gcloud
      - $HOME/.aws:/home/ci/.aws
    environment:
      - AWS_PROFILE
    ports:
      - "3000:3000"
    stdin_open: true
    tty: true
    command: bash -c "bin/dashboard-server"

volumes:
  mysqldata:
  rbenv:
  yarncache:
  gcloud_config:
